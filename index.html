<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Color Gate Switch — Prototype</title>
  <style>
    :root{--bg:#0b0b0c;--panel:#101012;--border:#25252a;--text:#e7e7ea;--muted:#9aa0a6;--accent:#7aa2f7;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);}
    .left{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap;}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px;}
    button{background:var(--panel);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;}
    main{height:calc(100% - 56px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:12px;}
    canvas{background:#070708;border:1px solid var(--border);border-radius:14px;touch-action:manipulation;}
    .hint{max-width:560px;text-align:center;color:var(--muted);font-size:13px;line-height:1.35;}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
    .colorDot{width:12px;height:12px;border-radius:999px;display:inline-block;vertical-align:middle;margin-right:6px;}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">Best: <b id="best">0</b></div>
      <div class="pill" id="status">Tap Start</div>
      <div class="pill" id="playerColorPill"><span class="colorDot" id="dot"></span><span id="colorName">—</span></div>
    </div>
    <div class="row">
      <button id="start">Start</button>
      <button id="speed">Speed: Normal</button>
    </div>
  </header>

  <main>
    <canvas id="c" width="360" height="540"></canvas>
    <div class="hint">
      <b>Color Gate Switch</b>: tap to cycle colors. Pass gates only if your color matches the gate at the moment you cross it.
      <br/>Designed for mobile (portrait).
    </div>
    <div class="hint">Tip: gates speed up slowly. If it feels unfair, we tune spacing &amp; colors.</div>
  </main>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('start');
  const speedBtn = document.getElementById('speed');
  const dot = document.getElementById('dot');
  const colorNameEl = document.getElementById('colorName');

  const COLORS = [
    { name: 'RED', hex: '#ff4d4d' },
    { name: 'BLUE', hex: '#4da3ff' },
    { name: 'GREEN', hex: '#44d27d' },
    { name: 'YELLOW', hex: '#ffd34d' },
  ];

  let best = Number(localStorage.getItem('cgs.best') || 0);
  bestEl.textContent = String(best);

  // responsive sizing
  function resize() {
    const w = Math.min(window.innerWidth - 24, 420);
    const h = Math.min(window.innerHeight - 140, 720);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
  }
  window.addEventListener('resize', resize);
  resize();

  const W = 360; // internal render size
  const H = 540;
  canvas.width = W;
  canvas.height = H;

  let running = false;
  let t = 0;
  let speedMode = 1; // 0 slow, 1 normal, 2 fast

  // player
  let player = { x: W/2, y: H-90, r: 16, colorIdx: 0 };

  // gates
  let gates = [];
  let gateY = -40;
  let gateSpeed = 2.8;

  function setPlayerColor(idx) {
    player.colorIdx = (idx + COLORS.length) % COLORS.length;
    const c = COLORS[player.colorIdx];
    dot.style.background = c.hex;
    colorNameEl.textContent = c.name;
  }

  function reset() {
    running = false;
    t = 0;
    player = { x: W/2, y: H-90, r: 16, colorIdx: 0 };
    setPlayerColor(0);
    gates = [];
    gateY = -40;
    gateSpeed = 2.8 + speedMode * 0.8;
    scoreEl.textContent = '0';
    statusEl.textContent = 'Tap Start';

    // seed
    for (let i = 0; i < 7; i++) spawnGate(true);
    draw();
  }

  function randInt(n){ return Math.floor(Math.random()*n); }

  function spawnGate(isSeed=false) {
    const colorIdx = randInt(COLORS.length);
    const thickness = 22;
    const gap = 110; // distance between gates

    const y = isSeed ? gateY : (Math.min(...gates.map(g=>g.y)) - gap);
    const g = {
      y,
      colorIdx,
      thickness,
      // make it visually interesting with split segments
      style: (Math.random() < 0.35) ? 'split' : 'full'
    };
    gates.push(g);
    gateY = y;
  }

  function start() {
    if (!running) {
      running = true;
      statusEl.textContent = 'Playing';
      loop();
    }
  }

  function gameOver(reason) {
    running = false;
    statusEl.textContent = `Game Over — ${reason}. Tap Start`;
  }

  function incrementScore() {
    const s = Number(scoreEl.textContent) + 1;
    scoreEl.textContent = String(s);
    if (s > best) {
      best = s;
      localStorage.setItem('cgs.best', String(best));
      bestEl.textContent = String(best);
    }
  }

  function gateColor(g){ return COLORS[g.colorIdx].hex; }

  function update(dt) {
    // gates move downwards (toward player)
    const sp = gateSpeed;
    for (const g of gates) g.y += sp;

    // recycle gates when they pass bottom
    const bottom = H + 80;
    const still = [];
    for (const g of gates) {
      if (g.y > bottom) {
        // gate passed (if we didn't collide), score
        incrementScore();
      } else {
        still.push(g);
      }
    }
    gates = still;

    while (gates.length < 7) spawnGate(false);

    // slow ramp
    gateSpeed = Math.min(6.5 + speedMode*0.6, gateSpeed + 0.0009 * dt);

    // collision check: when player crosses gate band
    for (const g of gates) {
      const bandTop = g.y;
      const bandBottom = g.y + g.thickness;
      const py = player.y;
      if (py - player.r <= bandBottom && py + player.r >= bandTop) {
        // we are intersecting the band; must match color
        if (player.colorIdx !== g.colorIdx) {
          gameOver('wrong color');
          return;
        }
      }
    }
  }

  function draw() {
    ctx.clearRect(0,0,W,H);

    // background
    ctx.fillStyle = '#070708';
    ctx.fillRect(0,0,W,H);

    // subtle lane
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.fillRect(40, 0, W-80, H);

    // gates
    for (const g of gates) {
      const c = gateColor(g);
      ctx.fillStyle = c;
      ctx.globalAlpha = 0.85;

      if (g.style === 'split') {
        // two segments with a tiny visual seam
        ctx.fillRect(40, g.y, (W-80)/2 - 4, g.thickness);
        ctx.fillRect(W/2 + 4, g.y, (W-80)/2 - 4, g.thickness);
      } else {
        ctx.fillRect(40, g.y, W-80, g.thickness);
      }

      // border glow
      ctx.globalAlpha = 1;
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 2;
      ctx.strokeRect(40, g.y, W-80, g.thickness);
    }

    // player
    const pc = COLORS[player.colorIdx].hex;
    ctx.fillStyle = pc;
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
    ctx.fill();

    // outline
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 3;
    ctx.stroke();

    // small direction hint
    ctx.fillStyle = 'rgba(255,255,255,0.55)';
    ctx.font = '12px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('tap to change color', W/2, H-30);
  }

  let last = null;
  function loop(ts) {
    if (!running) {
      draw();
      return;
    }
    if (last == null) last = ts;
    const dt = ts - last;
    last = ts;

    update(dt);
    draw();

    if (running) requestAnimationFrame(loop);
  }

  function cycleColor() {
    setPlayerColor(player.colorIdx + 1);
  }

  // input
  canvas.addEventListener('click', () => {
    if (!running) return;
    cycleColor();
  });
  startBtn.addEventListener('click', () => {
    if (!running) {
      last = null;
      start();
    } else {
      cycleColor();
    }
  });

  speedBtn.addEventListener('click', () => {
    speedMode = (speedMode + 1) % 3;
    speedBtn.textContent = `Speed: ${speedMode===0?'Slow':speedMode===1?'Normal':'Fast'}`;
    gateSpeed = 2.8 + speedMode * 0.8;
  });

  // mobile tap anywhere to change color while playing
  document.body.addEventListener('touchstart', (e) => {
    if (!running) return;
    // ignore when tapping buttons
    const t = e.target;
    if (t && (t.tagName === 'BUTTON')) return;
    cycleColor();
  }, { passive: true });

  reset();
})();
</script>
</body>
</html>
